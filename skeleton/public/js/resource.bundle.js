/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(function webpackUniversalModuleDefinition(root, factory) {
	if(typeof exports === 'object' && typeof module === 'object')
		module.exports = factory();
	else if(typeof define === 'function' && define.amd)
		define([], factory);
	else if(typeof exports === 'object')
		exports["AlxarafeResource"] = factory();
	else
		root["AlxarafeResource"] = factory();
})(self, () => {
return /******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./src/Frontend/ts/resource.ts"
/*!*************************************!*\
  !*** ./src/Frontend/ts/resource.ts ***!
  \*************************************/
(__unused_webpack_module, __webpack_exports__, __webpack_require__) {

eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   AlxarafeResource: () => (/* binding */ AlxarafeResource)\n/* harmony export */ });\nclass AlxarafeResource {\n    // Using global window.alxarafe_unsaved_changes\n    constructor(container, config) {\n        this.activeTab = '';\n        this.currentOffset = 0;\n        this.activeFilters = {};\n        this.searchDebounceTimer = null;\n        this.container = container;\n        this.config = config;\n        this.init();\n    }\n    init() {\n        var _a, _b, _c;\n        if (this.config.mode === 'list') {\n            this.activeTab = Object.keys(((_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) || {})[0] || '';\n            // Initialize filters with defaults from config if present\n            const tabs = ((_b = this.config.config.list) === null || _b === void 0 ? void 0 : _b.tabs) || {};\n            if ((_c = tabs[this.activeTab]) === null || _c === void 0 ? void 0 : _c.filters) {\n                tabs[this.activeTab].filters.forEach((f) => {\n                    if (f.value)\n                        this.activeFilters[f.field] = f.value;\n                });\n            }\n            this.renderListLayout();\n            this.fetchData();\n        }\n        else {\n            this.renderEdit();\n            // Global script in footer handles beforeunload if protectChanges is true\n        }\n        this.injectStyles();\n    }\n    // Removed setupUnsavedChangesProtection as it is handled globally in footer.blade.php\n    injectStyles() {\n        const styleId = 'alxarafe-resource-styles';\n        if (document.getElementById(styleId))\n            return;\n        const style = document.createElement('style');\n        style.id = styleId;\n        style.innerHTML = `\n            /* Scoped Select2 Fixes for Alxarafe Resource */\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection {\n                min-height: calc(1.5em + 0.75rem + 2px) !important; /* Standard BS5 input height */\n                padding: 0.375rem 0.75rem !important;\n                display: flex !important;\n                align-items: center !important;\n            }\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection__rendered {\n                line-height: 1.5 !important;\n                color: #212529 !important;\n                padding-left: 0 !important; /* Reset padding as parent has it */\n            }\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection__placeholder {\n                line-height: 1.5 !important;\n            }\n            /* Fix Dropdown too */\n            .select2-container--bootstrap-5 .select2-dropdown .select2-results__option {\n                padding: 0.375rem 0.75rem !important;\n            }\n        `;\n        document.head.appendChild(style);\n    }\n    // --- LIST MODE METHODS ---\n    renderListLayout() {\n        var _a, _b;\n        const tabs = ((_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) || {};\n        const currentTab = tabs[this.activeTab];\n        if (!currentTab) {\n            this.container.innerHTML = '<div class=\"alert alert-danger\">Configuration Error: Active tab not found.</div>';\n            return;\n        }\n        const buttons = ((_b = this.config.config.list) === null || _b === void 0 ? void 0 : _b.head_buttons) || [];\n        const leftButtons = buttons.filter((b) => b.location === 'left');\n        const rightButtons = buttons.filter((b) => !b.location || b.location === 'right');\n        const renderBtn = (b) => `\n            <button class=\"btn btn-sm btn-${b.type}\" \n                    ${b.action === 'js' ? `onclick=\"${b.target}\"` : `onclick=\"window.location.href='${b.target}'\"`}>\n                <i class=\"${b.icon} me-1\"></i> ${b.label}\n            </button>\n        `;\n        // Require template\n        if (!this.config.templates || !this.config.templates['layout_list']) {\n            this.container.innerHTML = '<div class=\"alert alert-danger\">Internal Error: Missing template \"layout_list\"</div>';\n            return;\n        }\n        this.container.innerHTML = this.config.templates['layout_list'];\n        // Inject Tabs\n        const tabsContainer = this.container.querySelector('#alxarafe-tabs-container');\n        if (tabsContainer)\n            tabsContainer.innerHTML = this.renderTabsNav();\n        // Inject Buttons\n        const leftContainer = this.container.querySelector('#alxarafe-toolbar-left');\n        if (leftContainer)\n            leftContainer.innerHTML = leftButtons.map(renderBtn).join('');\n        const rightContainer = this.container.querySelector('#alxarafe-toolbar-right');\n        if (rightContainer)\n            rightContainer.innerHTML = rightButtons.map(renderBtn).join('');\n        // Inject Table Headers\n        const theadRow = this.container.querySelector('#alxarafe-table-head');\n        if (theadRow) {\n            theadRow.innerHTML = currentTab.columns.map((col) => `\n                    <th class=\"py-3 px-4 border-0\">${col.label}</th>\n                `).join('') + '<th class=\"text-end py-3 px-4 border-0\" style=\"width: 120px;\">Acciones</th>';\n        }\n        this.renderFilters(currentTab.filters || []);\n        // Setup toggle icon rotation logic (simple CSS or JS listener)\n        const collapseEl = this.container.querySelector('#alxarafe-filters-collapse');\n        if (collapseEl) {\n            collapseEl.addEventListener('hide.bs.collapse', () => {\n                var _a;\n                (_a = this.container.querySelector('.card-header .fa-chevron-up')) === null || _a === void 0 ? void 0 : _a.classList.replace('fa-chevron-up', 'fa-chevron-down');\n            });\n            collapseEl.addEventListener('show.bs.collapse', () => {\n                var _a;\n                (_a = this.container.querySelector('.card-header .fa-chevron-down')) === null || _a === void 0 ? void 0 : _a.classList.replace('fa-chevron-down', 'fa-chevron-up');\n            });\n        }\n        this.setupAlertHelper();\n    }\n    setupAlertHelper() {\n        if (!document.getElementById('alxarafe-alerts')) {\n            const alertsDiv = document.createElement('div');\n            alertsDiv.id = 'alxarafe-alerts';\n            this.container.prepend(alertsDiv);\n        }\n    }\n    showMessage(msg, type = 'info') {\n        const alertsDiv = document.getElementById('alxarafe-alerts');\n        if (!alertsDiv)\n            return;\n        const alertHtml = `\n            <div class=\"alert alert-${type} alert-dismissible fade show\" role=\"alert\">\n                ${msg}\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n            </div>\n        `;\n        alertsDiv.insertAdjacentHTML('beforeend', alertHtml);\n    }\n    renderTabsNav() {\n        var _a;\n        const tabs = ((_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) || {};\n        const tabKeys = Object.keys(tabs);\n        if (tabKeys.length <= 1)\n            return '';\n        return `\n            <ul class=\"nav nav-tabs mb-4\">\n                ${tabKeys.map(key => `\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link ${this.activeTab === key ? 'active' : ''}\" \n                           href=\"#\" \n                           data-tab=\"${key}\"\n                           onclick=\"event.preventDefault();\">\n                           ${tabs[key].title || tabs[key].label || key}\n                        </a>\n                    </li>\n                `).join('')}\n            </ul>\n        `;\n    }\n    handleTabClick(e) {\n        const target = e.target.closest('.nav-link');\n        if (!target)\n            return;\n        const newTab = target.dataset.tab;\n        if (newTab && newTab !== this.activeTab) {\n            this.activeTab = newTab;\n            this.currentOffset = 0;\n            // Clear active filters when switching tabs\n            this.activeFilters = {};\n            // Re-render layout\n            this.renderListLayout();\n            this.fetchData();\n        }\n    }\n    renderFilters(filters) {\n        var _a;\n        const row = this.container.querySelector('#alxarafe-filters-row');\n        // Re-bind tab events logic if we just re-rendered layout\n        this.container.querySelectorAll('.nav-tabs .nav-link').forEach(link => {\n            link.addEventListener('click', (e) => this.handleTabClick(e));\n        });\n        if (!row)\n            return;\n        if (filters.length === 0) {\n            (_a = this.container.querySelector('#alxarafe-filters-container')) === null || _a === void 0 ? void 0 : _a.remove();\n            return;\n        }\n        row.innerHTML = filters.map((f) => {\n            const val = this.activeFilters[f.field] || '';\n            const clearBtn = val ? `\n                <button class=\"btn btn-outline-secondary alxarafe-filter-clear\" type=\"button\" data-field=\"${f.field}\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            ` : '';\n            if (f.type === 'text') {\n                return `\n                    <div class=\"col-md-3\">\n                        <div class=\"input-group input-group-sm\">\n                            <input type=\"text\"\n                                class=\"form-control alxarafe-filter-input\"\n                                data-field=\"${f.field}\"\n                                placeholder=\"${f.label}...\"\n                                value=\"${val}\">\n                            ${clearBtn}\n                        </div>\n                    </div>\n                `;\n            }\n            else if (f.type === 'select' || f.type === 'select2') {\n                const isSelect2 = f.type === 'select2';\n                const options = Object.entries(f.options || {}).map(([k, v]) => `<option value=\"${k}\" ${String(k) === String(val) ? 'selected' : ''}>${v}</option>`).join('');\n                if (isSelect2) {\n                    return `\n                    <div class=\"col-md-3 alxarafe-select2-wrapper\">\n                        <select class=\"form-select form-select-sm alxarafe-filter-input select2\" data-field=\"${f.field}\" style=\"width: 100%\" data-placeholder=\"-- ${f.label} --\">\n                            <option value=\"\">-- ${f.label} --</option>\n                            ${options}\n                        </select>\n                    </div>`;\n                }\n                else {\n                    return `\n                    <div class=\"col-md-3\">\n                         <div class=\"input-group input-group-sm\">\n                            <select class=\"form-select alxarafe-filter-input\" data-field=\"${f.field}\">\n                                <option value=\"\">-- ${f.label} --</option>\n                                ${options}\n                            </select>\n                            ${val ? clearBtn : ''}\n                        </div>\n                    </div>\n                `;\n                }\n            }\n            return '';\n        }).join('');\n        // Attach clear events\n        row.querySelectorAll('.alxarafe-filter-clear').forEach(btn => {\n            btn.addEventListener('click', (e) => {\n                const field = e.currentTarget.dataset.field;\n                this.clearFilter(field);\n            });\n        });\n        // Initialize Select2 if available\n        if (typeof window.refrescar_select2 === 'function') {\n            window.refrescar_select2();\n            // Handle Select2 Change (using jQuery from global)\n            const $ = window.jQuery;\n            if ($) {\n                $(row).find('.select2').on('change', (e) => {\n                    const field = e.target.getAttribute('data-field');\n                    const val = $(e.target).val();\n                    this.activeFilters[field] = val;\n                    this.currentOffset = 0;\n                    this.fetchData();\n                });\n            }\n        }\n        // Attach events\n        row.querySelectorAll('.alxarafe-filter-input:not(.select2)').forEach(input => {\n            if (input.tagName === 'SELECT') {\n                input.addEventListener('change', (e) => this.handleFilterChange(e));\n            }\n            else {\n                input.addEventListener('input', (e) => this.handleFilterChange(e));\n            }\n        });\n    }\n    handleFilterChange(e) {\n        const target = e.target;\n        const field = target.dataset.field;\n        if (!field)\n            return;\n        const val = target.value;\n        this.activeFilters[field] = val;\n        // Reset offset on filter change\n        this.currentOffset = 0;\n        // Debounce for text inputs\n        if (target.type === 'text') {\n            clearTimeout(this.searchDebounceTimer);\n            this.searchDebounceTimer = setTimeout(() => this.fetchData(), 300);\n        }\n        else {\n            this.fetchData();\n        }\n        // Re-render filters (to toggle clear buttons)\n        this.renderFilters(this.getFiltersConfig());\n    }\n    clearFilter(field) {\n        if (!field)\n            return;\n        delete this.activeFilters[field];\n        this.currentOffset = 0;\n        this.fetchData();\n        this.renderFilters(this.getFiltersConfig());\n    }\n    getFiltersConfig() {\n        var _a;\n        const tabs = ((_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) || {};\n        const currentTab = tabs[this.activeTab];\n        return currentTab ? (currentTab.filters || []) : [];\n    }\n    async fetchData() {\n        this.setTableLoading(true);\n        const url = new URL(window.location.href);\n        url.searchParams.set('ajax', 'get_data');\n        url.searchParams.set('tab', this.activeTab);\n        url.searchParams.set('offset', String(this.currentOffset));\n        // Add filters to URL\n        Object.entries(this.activeFilters).forEach(([key, val]) => {\n            if (val)\n                url.searchParams.set(`filter_${this.activeTab}_${key}`, val);\n        });\n        try {\n            const response = await fetch(url.toString(), {\n                headers: { 'X-Requested-With': 'XMLHttpRequest' }\n            });\n            if (!response.ok)\n                throw new Error('Network error');\n            const result = await response.json();\n            this.populateTable(result.data);\n            this.renderPagination(result.meta);\n        }\n        catch (error) {\n            this.showTableError(String(error));\n        }\n    }\n    populateTable(rows) {\n        var _a, _b;\n        const tbody = this.container.querySelector('#alxarafe-table-body');\n        if (!tbody)\n            return;\n        if (!rows || rows.length === 0) {\n            tbody.innerHTML = '<tr><td colspan=\"100\" class=\"text-center p-4 text-muted\">No se encontraron resultados.</td></tr>';\n            return;\n        }\n        const currentTab = (_b = (_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) === null || _b === void 0 ? void 0 : _b[this.activeTab];\n        tbody.innerHTML = rows.map((row) => {\n            var _a, _b;\n            return `\n            <tr onclick=\"window.location.href='?${this.getRoutingParams()}&id=${(_a = row.id) !== null && _a !== void 0 ? _a : row.code}'\" style=\"cursor: pointer; transition: background-color 0.2s;\">\n                ${currentTab.columns.map((col) => `\n                    <td class=\"px-4 py-3 text-secondary\">${this.formatValue(row[col.field], col, row)}</td>\n                `).join('')}\n                <td class=\"text-end px-4 py-3\">\n                    <a href=\"?${this.getRoutingParams()}&id=${(_b = row.id) !== null && _b !== void 0 ? _b : row.code}\" class=\"btn btn-sm btn-outline-primary rounded-pill px-3\" title=\"Editar\">\n                        <i class=\"fas fa-pen small\"></i>\n                    </a>\n                </td>\n            </tr>\n        `;\n        }).join('');\n        // Trigger local data formatting after render\n        this.formatLocalData();\n    }\n    formatLocalData() {\n        // 1. Dates\n        const dateEls = this.container.querySelectorAll('.alx-date-local');\n        dateEls.forEach((el) => {\n            const val = el.dataset.value;\n            if (!val)\n                return;\n            try {\n                const date = new Date(val);\n                if (!isNaN(date.getTime())) {\n                    el.innerText = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\\//g, '-');\n                }\n            }\n            catch (e) { }\n        });\n        // 2. DateTimes\n        const dateTimeEls = this.container.querySelectorAll('.alx-datetime-local');\n        dateTimeEls.forEach((el) => {\n            const val = el.dataset.value;\n            if (!val)\n                return;\n            try {\n                const date = new Date(val);\n                if (!isNaN(date.getTime())) {\n                    el.innerText = date.toLocaleString();\n                }\n            }\n            catch (e) { }\n        });\n        // 3. Decimals / Numbers\n        const decimalEls = this.container.querySelectorAll('.alx-decimal-local');\n        decimalEls.forEach((el) => {\n            const val = parseFloat(el.dataset.value);\n            if (isNaN(val))\n                return;\n            try {\n                el.innerText = val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });\n            }\n            catch (e) { }\n        });\n        // 4. Time\n        const timeEls = this.container.querySelectorAll('.alx-time-local');\n        timeEls.forEach((el) => {\n            // Time usually comes as HH:MM:SS. We can just show it as is or try to format it?\n            // Browser doesn't have a simple \"Time String Formatter\" from just a time string without date.\n            // We can use a dummy date.\n            const val = el.dataset.value;\n            if (!val)\n                return;\n            // Basic check if it is HH:MM:SS\n            if (val.includes(':')) {\n                // Leave as is or format:\n                // el.innerText = val.substring(0, 5); // HH:MM\n                // Let's truncate seconds if they are 00?\n                // User wants \"browser configuration\". Browser usually shows HH:MM for time inputs.\n                // Let's stick with HH:MM\n                if (val.length === 8) {\n                    el.innerText = val.substring(0, 5);\n                }\n            }\n        });\n    }\n    renderPagination(meta) {\n        const container = this.container.querySelector('#alxarafe-pagination');\n        if (!container)\n            return;\n        const { total, limit, offset } = meta;\n        const currentPage = Math.floor(offset / limit) + 1;\n        const totalPages = Math.ceil(total / limit);\n        const start = offset + 1;\n        const end = Math.min(offset + limit, total);\n        if (total === 0) {\n            container.innerHTML = '';\n            return;\n        }\n        const buildPageItem = (page, label, disabled = false, active = false) => `\n            <li class=\"page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}\">\n                <button class=\"page-link\" ${typeof page === 'number' ? `data-page=\"${page}\"` : ''} ${typeof page !== 'number' ? 'disabled' : ''}>${label}</button>\n            </li>\n        `;\n        // Logic for sliding window\n        let pagesParams = [];\n        if (totalPages <= 7) {\n            for (let i = 1; i <= totalPages; i++)\n                pagesParams.push(i);\n        }\n        else {\n            pagesParams.push(1);\n            if (currentPage > 3)\n                pagesParams.push('...');\n            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {\n                pagesParams.push(i);\n            }\n            if (currentPage < totalPages - 2)\n                pagesParams.push('...');\n            pagesParams.push(totalPages);\n        }\n        const itemsHtml = `\n            ${buildPageItem(currentPage - 1, '<i class=\"fas fa-chevron-left\"></i>', currentPage === 1)}\n            ${pagesParams.map(p => {\n            if (p === '...')\n                return '<li class=\"page-item disabled\"><span class=\"page-link\">...</span></li>';\n            return buildPageItem(p, String(p), false, p === currentPage);\n        }).join('')}\n            ${buildPageItem(currentPage + 1, '<i class=\"fas fa-chevron-right\"></i>', currentPage === totalPages)}\n        `;\n        if (this.config.templates && this.config.templates['layout_pagination']) {\n            let html = this.config.templates['layout_pagination'];\n            html = html.split('{{start}}').join(String(start));\n            html = html.split('{{end}}').join(String(end));\n            html = html.split('{{total}}').join(String(total));\n            html = html.split('{{items}}').join(itemsHtml);\n            container.innerHTML = html;\n        }\n        else {\n            container.innerHTML = '<div class=\"alert alert-warning\">Missing template: layout_pagination</div>';\n        }\n        container.querySelectorAll('button[data-page]:not([disabled])').forEach(btn => {\n            btn.addEventListener('click', (e) => {\n                const target = e.target;\n                const btnEl = target.closest('button');\n                if (!btnEl || !btnEl.dataset.page)\n                    return;\n                const targetPage = parseInt(btnEl.dataset.page);\n                this.currentOffset = (targetPage - 1) * limit;\n                this.fetchData();\n            });\n        });\n    }\n    setTableLoading(loading) {\n        var _a, _b, _c, _d;\n        const tbody = this.container.querySelector('#alxarafe-table-body');\n        if (!tbody)\n            return;\n        if (loading) {\n            const cols = (((_d = (_c = (_b = (_a = this.config.config.list) === null || _a === void 0 ? void 0 : _a.tabs) === null || _b === void 0 ? void 0 : _b[this.activeTab]) === null || _c === void 0 ? void 0 : _c.columns) === null || _d === void 0 ? void 0 : _d.length) || 0) + 1;\n            tbody.innerHTML = `<tr><td colspan=\"${cols}\" class=\"text-center p-5\"><div class=\"spinner-border text-primary\" role=\"status\"></div><br>Cargando...</td></tr>`;\n        }\n    }\n    showTableError(msg) {\n        const tbody = this.container.querySelector('#alxarafe-table-body');\n        if (tbody)\n            tbody.innerHTML = `<tr><td colspan=\"100\" class=\"text-center text-danger p-4\">Error: ${msg}</td></tr>`;\n    }\n    // --- UTILS ---\n    formatValue(cellValue, col, row) {\n        var _a;\n        if (typeof col === 'string') {\n            col = { type: col };\n        }\n        // 1. If PHP already resolved the value (e.g. \"Spain\"), use it.\n        // PHP ResourceController::processResultModels resolves dot notation into flat keys.\n        let value = cellValue;\n        // 2. Only if value is missing, retry dot notation on the full row object (redundancy)\n        if ((value === null || value === undefined) && col.field && col.field.includes('.')) {\n            try {\n                value = col.field.split('.').reduce((acc, part) => (acc && acc[part] !== undefined) ? acc[part] : null, row);\n            }\n            catch (e) {\n                value = null;\n            }\n        }\n        const type = col.component || col.type || 'text';\n        // Try generic template first (Including date/datetime now)\n        const tpl = (_a = this.config.templates) === null || _a === void 0 ? void 0 : _a[type.toLowerCase() + '_list'];\n        if (tpl) {\n            let html = tpl;\n            const safeValue = value !== null && value !== undefined ? value : '';\n            html = html.split('{{value}}').join(safeValue);\n            // Boolean check\n            if (type === 'boolean') {\n                const isChecked = safeValue === true || safeValue === 1 || safeValue === '1' || safeValue === 'true';\n                html = html.split('{{checked}}').join(isChecked ? 'checked' : '');\n            }\n            else {\n                html = html.split('{{checked}}').join('');\n            }\n            // Date formatting in list\n            if (type === 'date' && safeValue) {\n                try {\n                    const date = new Date(safeValue);\n                    if (!isNaN(date.getTime())) {\n                        const formatted = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\\//g, '-');\n                        html = html.split(safeValue).join(formatted);\n                    }\n                }\n                catch (e) { }\n            }\n            return html;\n        }\n        // Fallback Logic\n        if (value === null || value === undefined)\n            return '';\n        if (col.type === 'icon' || col.component === 'icon') {\n            const map = col.map || {};\n            const iconClass = map[String(value)] !== undefined ? map[String(value)] : '';\n            if (iconClass) {\n                return `<i class=\"${iconClass}\"></i>`;\n            }\n            return '';\n        }\n        if (col.type === 'boolean') {\n            const isChecked = Boolean(value) && String(value) !== '0';\n            return `<div class=\"text-center\"><input type=\"checkbox\" class=\"form-check-input\" ${isChecked ? 'checked' : ''} disabled></div>`;\n        }\n        // Date/Datetime HARDCODED LOGIC REMOVED - using templates now.\n        return String(value);\n    }\n    getRoutingParams() {\n        const url = new URL(window.location.href);\n        const params = new URLSearchParams();\n        if (url.searchParams.has('page'))\n            params.set('page', url.searchParams.get('page'));\n        if (url.searchParams.has('module'))\n            params.set('module', url.searchParams.get('module'));\n        if (url.searchParams.has('controller'))\n            params.set('controller', url.searchParams.get('controller'));\n        return params.toString();\n    }\n    // --- EDIT MODE METHODS ---\n    renderEdit() {\n        var _a;\n        if (this.config.templates && this.config.templates['layout_edit']) {\n            this.container.innerHTML = this.config.templates['layout_edit'];\n        }\n        else {\n            this.container.innerHTML = '<div class=\"alert alert-danger\">Internal Error: Missing template \"layout_edit\"</div>';\n            return;\n        }\n        this.loadRecordData();\n        this.setupAlertHelper();\n        const btnSave = this.container.querySelector('#btn-save');\n        if (btnSave) {\n            btnSave.addEventListener('click', () => this.handleSave());\n            // Add Revert Button next to Save\n            const btnRevert = document.createElement('button');\n            btnRevert.type = 'button';\n            btnRevert.className = 'btn btn-secondary ms-2';\n            btnRevert.innerHTML = '<i class=\"fas fa-sync-alt me-1\"></i> Recargar';\n            btnRevert.onclick = () => {\n                if (confirm('¿Seguro que quieres descartar los cambios y recargar los datos originales?')) {\n                    this.loadRecordData();\n                    window.alxarafe_unsaved_changes = false;\n                }\n            };\n            (_a = btnSave.parentNode) === null || _a === void 0 ? void 0 : _a.insertBefore(btnRevert, btnSave.nextSibling);\n        }\n    }\n    async loadRecordData() {\n        const url = new URL(window.location.href);\n        url.searchParams.set('ajax', 'get_record');\n        try {\n            const response = await fetch(url.toString(), {\n                headers: { 'X-Requested-With': 'XMLHttpRequest' }\n            });\n            const result = await response.json();\n            if (result.error)\n                throw new Error(result.error);\n            this.buildForm(result.data);\n        }\n        catch (error) {\n            const container = this.container.querySelector('#edit-form-container');\n            if (container)\n                container.innerHTML = `<div class=\"alert alert-danger\">Error: ${error}</div>`;\n        }\n    }\n    buildForm(data) {\n        var _a;\n        const container = this.container.querySelector('#edit-form-container');\n        if (!container)\n            return;\n        const sections = ((_a = this.config.config.edit) === null || _a === void 0 ? void 0 : _a.sections) || {};\n        const entries = Object.entries(sections);\n        if (entries.length === 0) {\n            container.innerHTML = '<div class=\"alert alert-warning\">No sections defined</div>';\n            return;\n        }\n        // 1. Build Nav Tabs\n        let navHtml = '<ul class=\"nav nav-tabs mb-3\" role=\"tablist\">';\n        entries.forEach(([secId, sec], index) => {\n            const activeClass = index === 0 ? 'active' : '';\n            navHtml += `\n                <li class=\"nav-item\" role=\"presentation\">\n                    <button class=\"nav-link ${activeClass}\" id=\"${secId}-tab\" data-bs-toggle=\"tab\" data-bs-target=\"#tab-${secId}\" type=\"button\" role=\"tab\">\n                        ${sec.title}\n                    </button>\n                </li>\n            `;\n        });\n        navHtml += '</ul>';\n        // 2. Build Tab Content\n        let contentHtml = '<form id=\"alxarafe-edit-form\"><div class=\"tab-content\">';\n        entries.forEach(([secId, sec], index) => {\n            const activeClass = index === 0 ? 'show active' : '';\n            contentHtml += `\n                <div class=\"tab-pane fade ${activeClass}\" id=\"tab-${secId}\" role=\"tabpanel\">\n                    <div class=\"container-fluid p-0\">\n                        <div class=\"row\">\n            `;\n            // If fields are defined in the section configuration (from getEditFields), use them\n            // This preserves order and specific configurations like readonly, label overrides, etc.\n            if (sec.fields) {\n                // Ensure sec.fields is an array (it comes as an object/array from PHP)\n                const fieldsArray = Object.values(sec.fields);\n                fieldsArray.forEach((field) => {\n                    const value = data[field.field] !== undefined ? data[field.field] : '';\n                    contentHtml += this.renderField(field, value);\n                });\n            }\n            contentHtml += `\n                        </div>\n                    </div>\n                </div>\n            `;\n        });\n        contentHtml += '</div></form>';\n        container.innerHTML = navHtml + contentHtml;\n        // Monitor changes\n        if (this.config.protectChanges) {\n            const form = container.querySelector('form');\n            if (form) {\n                form.addEventListener('input', () => { window.alxarafe_unsaved_changes = true; });\n                form.addEventListener('change', () => { window.alxarafe_unsaved_changes = true; });\n            }\n        }\n    }\n    getColClass(field) {\n        var _a, _b;\n        if ((_a = field.options) === null || _a === void 0 ? void 0 : _a.full_width)\n            return 'col-12';\n        if ((_b = field.options) === null || _b === void 0 ? void 0 : _b.col)\n            return `col-md-${field.options.col}`;\n        return 'col-md-6';\n    }\n    renderField(field, value) {\n        var _a, _b, _c, _d, _e, _f, _g;\n        const type = field.type || field.component || 'text';\n        const lowerType = type.toLowerCase();\n        console.log('[AlxarafeResource] renderField:', { field: field.field, type, value });\n        const tpl = (_a = this.config.templates) === null || _a === void 0 ? void 0 : _a[lowerType + '_edit'];\n        const colClass = this.getColClass(field);\n        if (tpl) {\n            let html = tpl;\n            html = html.split('{{field}}').join(field.field);\n            html = html.split('{{label}}').join(field.label);\n            // Attempt to replace standard column class if present in template\n            html = html.replace('col-md-6', colClass);\n            let safeValue = value !== null && value !== undefined ? value : '';\n            // Normailize type check\n            if (lowerType === 'date') {\n                // Ensure string to match regex\n                const strVal = String(safeValue);\n                // Extract YYYY-MM-DD\n                const match = strVal.match(/(\\d{4}-\\d{2}-\\d{2})/);\n                if (match) {\n                    safeValue = match[1];\n                }\n                else if (safeValue instanceof Date) {\n                    // Fallback if value was a Date object (unlikely via JSON but possible in some setups)\n                    const y = safeValue.getFullYear();\n                    const m = String(safeValue.getMonth() + 1).padStart(2, '0');\n                    const d = String(safeValue.getDate()).padStart(2, '0');\n                    safeValue = `${y}-${m}-${d}`;\n                }\n            }\n            html = html.split('{{value}}').join(safeValue);\n            // Boolean Attributes (required, readonly)\n            const boolAttrs = ['required', 'readonly', 'disabled'];\n            boolAttrs.forEach(attr => {\n                var _a;\n                const hasAttr = field[attr] === true || ((_a = field.options) === null || _a === void 0 ? void 0 : _a[attr]) === true;\n                html = html.split(`{{${attr}}}`).join(hasAttr ? attr : '');\n            });\n            // Value Attributes (min, max, step, maxlength)\n            const valAttrs = ['min', 'max', 'step', 'maxlength', 'placeholder'];\n            valAttrs.forEach(attr => {\n                var _a, _b;\n                const val = (_a = field[attr]) !== null && _a !== void 0 ? _a : (_b = field.options) === null || _b === void 0 ? void 0 : _b[attr];\n                if (val !== undefined && val !== null) {\n                    html = html.split(`{{${attr}}}`).join(`${attr}=\"${val}\"`);\n                }\n                else {\n                    html = html.split(`{{${attr}}}`).join('');\n                }\n            });\n            // Specific Check for Boolean checked\n            if (type === 'boolean') {\n                // Check various truthy values\n                const isChecked = value === true || value === 1 || value === '1' || value === 'true';\n                html = html.split('{{checked}}').join(isChecked ? 'checked' : '');\n            }\n            else {\n                // Clean up leftover {{checked}} for non-boolean fields just in case\n                html = html.split('{{checked}}').join('');\n            }\n            return html;\n        }\n        // Select Field\n        if (lowerType === 'select') {\n            const options = ((_b = field.options) === null || _b === void 0 ? void 0 : _b.values) || {};\n            let optionsHtml = '<option value=\"\">-- Seleccionar --</option>';\n            const safeValue = value !== null && value !== undefined ? value : '';\n            // Handle both object {k:v} and array [{id:k, name:v}] formats if needed\n            // Standardizing on { value: label } object/map\n            if (Array.isArray(options)) {\n                // If simple array of strings/numbers\n                options.forEach((opt) => {\n                    const val = typeof opt === 'object' ? opt.id : opt;\n                    const lab = typeof opt === 'object' ? (opt.name || opt.label) : opt;\n                    const selected = String(val) === String(safeValue) ? 'selected' : '';\n                    optionsHtml += `<option value=\"${val}\" ${selected}>${lab}</option>`;\n                });\n            }\n            else {\n                Object.entries(options).forEach(([k, v]) => {\n                    const selected = String(k) === String(safeValue) ? 'selected' : '';\n                    optionsHtml += `<option value=\"${k}\" ${selected}>${v}</option>`;\n                });\n            }\n            const selectId = `select-${field.field}-${Math.random().toString(36).substr(2, 9)}`;\n            // Post-render init hook\n            setTimeout(() => {\n                var _a;\n                if (window.jQuery && window.jQuery().select2) {\n                    window.jQuery(`#${selectId}`).select2({\n                        theme: 'bootstrap-5',\n                        width: '100%',\n                        placeholder: '-- Seleccionar --',\n                        allowClear: !((_a = field.options) === null || _a === void 0 ? void 0 : _a.required)\n                    }).on('change', (e) => {\n                        // Trigger native change for dirty checking\n                        e.target.dispatchEvent(new Event('change', { bubbles: true }));\n                    });\n                }\n            }, 100);\n            return `\n                <div class=\"${colClass} mb-3 alxarafe-select2-wrapper\">\n                    <label class=\"form-label small fw-bold text-secondary\">${field.label}</label>\n                    <select class=\"form-select alx-select2\" id=\"${selectId}\" name=\"${field.field}\" \n                        ${((_c = field.options) === null || _c === void 0 ? void 0 : _c.required) ? 'required' : ''} \n                        ${((_d = field.options) === null || _d === void 0 ? void 0 : _d.disabled) ? 'disabled' : ''}>\n                        ${optionsHtml}\n                    </select>\n                </div>\n            `;\n        }\n        // Relation List (HasMany)\n        if (lowerType === 'relation_list' || lowerType === 'relationlist') {\n            const rows = Array.isArray(value) ? value : [];\n            let cols = ((_e = field.options) === null || _e === void 0 ? void 0 : _e.columns) || [];\n            // Support associative array from PHP (Object in JS)\n            if (!Array.isArray(cols) && typeof cols === 'object') {\n                cols = Object.entries(cols).map(([k, v]) => ({ field: k, label: v }));\n            }\n            if (cols.length === 0 && rows.length > 0) {\n                // Auto-detect columns from first row if not provided (simple fallback)\n                Object.keys(rows[0]).forEach(k => {\n                    if (k !== 'id' && k !== 'created_at' && k !== 'updated_at' && k !== 'deleted_at') {\n                        cols.push(k);\n                    }\n                });\n            }\n            // Start Inline Edit Logic\n            const tableId = `relation-table-${field.field}`;\n            // Helper to render a single row (edit mode)\n            const renderRow = (row, index) => {\n                const cells = cols.map((c) => {\n                    var _a;\n                    const f = typeof c === 'string' ? c : c.field;\n                    const val = (_a = row[f]) !== null && _a !== void 0 ? _a : '';\n                    const inputName = `${field.field}[${index}][${f}]`;\n                    return `\n                        <td class=\"ps-3 py-2 small\">\n                            <input type=\"text\" class=\"form-control form-control-sm\" name=\"${inputName}\" value=\"${val}\">\n                        </td>\n                    `;\n                }).join('');\n                const idInput = row.id ? `<input type=\"hidden\" name=\"${field.field}[${index}][id]\" value=\"${row.id}\">` : '';\n                // Soft Delete (Disable inputs to trigger backend Sync deletion)\n                const deleteJs = `\n                    const tr = this.closest('tr');\n                    const isDel = tr.classList.contains('table-danger');\n                    if (isDel) {\n                        tr.classList.remove('table-danger', 'text-decoration-line-through');\n                        tr.style.opacity = '1';\n                        tr.querySelectorAll('input').forEach(i => i.disabled = false);\n                        this.className = 'btn btn-sm btn-outline-danger';\n                        this.innerHTML = '<i class=\"fas fa-trash\"></i>';\n                    } else {\n                        tr.classList.add('table-danger', 'text-decoration-line-through');\n                        tr.style.opacity = '0.6';\n                        tr.querySelectorAll('input').forEach(i => i.disabled = true);\n                        this.className = 'btn btn-sm btn-outline-secondary';\n                        this.innerHTML = '<i class=\"fas fa-undo\"></i>';\n                    }\n                    if(window.alxarafe_unsaved_changes !== undefined) window.alxarafe_unsaved_changes = true;\n                `.replace(/\\s+/g, ' ');\n                const safeDeleteJs = deleteJs.replace(/\"/g, '&quot;');\n                const deleteBtn = `\n                    <td class=\"text-end pe-3 py-2\">\n                        <button type=\"button\" class=\"btn btn-sm btn-outline-danger\" onclick=\"${safeDeleteJs}\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    </td>\n                `;\n                return `<tr>${cells}${deleteBtn}${idInput}</tr>`;\n            };\n            const renderBody = () => {\n                if (rows.length === 0) {\n                    // Start with one empty row? Or message?\n                    // Let's return empty and rely on Add button.\n                    return '';\n                }\n                return rows.map((row, i) => renderRow(row, i)).join('');\n            };\n            const renderHeader = () => {\n                const headers = cols.map((c) => {\n                    const label = typeof c === 'string' ? (c.charAt(0).toUpperCase() + c.slice(1)) : (c.label || c.field);\n                    return `<th class=\"small text-muted border-0 ps-3\">${label}</th>`;\n                }).join('');\n                // Action column\n                return `${headers}<th class=\"small text-muted border-0 text-end pe-3\" style=\"width: 50px;\"></th>`;\n            };\n            // Expose addRow function globally (hack for inline onclick)\n            // Ideally we'd bind events.\n            window[`addRelationRow_${field.field}`] = () => {\n                const tbody = document.querySelector(`#${tableId} tbody`);\n                if (tbody) {\n                    const newIndex = new Date().getTime(); // Simple unique index\n                    // Create empty row object based on cols\n                    const newRow = {};\n                    // Render row (using string, need to ensure correct escaping/context)\n                    // Re-use renderRow logic but simpler for JS string injection\n                    // Better: Insert HTML directly\n                    const html = renderRow({}, newIndex);\n                    tbody.insertAdjacentHTML('beforeend', html);\n                }\n            };\n            const createUrl = (_f = field.options) === null || _f === void 0 ? void 0 : _f.create_url;\n            // If create_url exists, use link. If NOT, use inline Add button.\n            const addBtn = createUrl ?\n                `<a href=\"${createUrl}\" class=\"btn btn-sm btn-outline-primary float-end\" target=\"_blank\"><i class=\"fas fa-plus\"></i> Añadir</a>` :\n                `<button type=\"button\" class=\"btn btn-sm btn-outline-primary float-end\" onclick=\"window['addRelationRow_${field.field}']()\"><i class=\"fas fa-plus\"></i> Añadir</button>`;\n            // Relation Lists default to full width unless specified\n            const relColClass = ((_g = field.options) === null || _g === void 0 ? void 0 : _g.col) ? `col-md-${field.options.col}` : 'col-12';\n            return `\n                <div class=\"${relColClass} mt-3 mb-3\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <label class=\"form-label fw-bold text-secondary mb-0\">${field.label}</label>\n                        ${addBtn}\n                    </div>\n                    <div class=\"card border-0 shadow-sm\">\n                        <div class=\"table-responsive\">\n                            <table class=\"table table-hover mb-0\" id=\"${tableId}\">\n                                <thead class=\"bg-light\">\n                                    <tr>${renderHeader()}</tr>\n                                </thead>\n                                <tbody>${renderBody()}</tbody>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n            `;\n        }\n        // Fallback for text\n        return `\n            <div class=\"${colClass}\">\n                <label class=\"form-label small fw-bold text-secondary\">${field.label}</label>\n                <input type=\"text\" class=\"form-control\" name=\"${field.field}\" value=\"${value}\">\n            </div>\n        `;\n    }\n    async handleSave() {\n        const form = this.container.querySelector('#alxarafe-edit-form');\n        if (!form)\n            return;\n        const btnSave = this.container.querySelector('#btn-save');\n        const originalBtnHtml = btnSave.innerHTML;\n        btnSave.disabled = true;\n        btnSave.innerHTML = '<span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span> Guardando...';\n        // Gather Data\n        const formData = new FormData(form);\n        const data = {};\n        // Handle standard inputs\n        formData.forEach((value, key) => {\n            data[key] = value;\n        });\n        // Handle checkboxes (unchecked checkboxes are not sent by FormData)\n        const checkBoxes = form.querySelectorAll('input[type=\"checkbox\"]');\n        checkBoxes.forEach((cb) => {\n            data[cb.name] = cb.checked;\n        });\n        const url = new URL(window.location.href);\n        url.searchParams.set('ajax', 'save_record');\n        // Ensure id is passed if we are editing 'new' or existing\n        if (this.config.recordId) {\n            url.searchParams.set('id', String(this.config.recordId));\n        }\n        try {\n            // Send as JSON\n            const payload = { data: {} };\n            for (const [key, val] of Object.entries(data)) {\n                payload.data[key] = val;\n            }\n            const response = await fetch(url.toString(), {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    'X-Requested-With': 'XMLHttpRequest'\n                },\n                body: JSON.stringify(payload)\n            });\n            const result = await response.json();\n            if (result.status === 'error' || result.error) {\n                let msg = result.error || 'Unknown error';\n                if (result.errors && Array.isArray(result.errors)) {\n                    msg = result.errors.join('<br>');\n                }\n                throw new Error(msg);\n            }\n            // Update Form Data if returned\n            if (result.status === 'success') {\n                this.showMessage(result.message || 'Guardado correctamente', 'success');\n                window.alxarafe_unsaved_changes = false; // Reset flag on success\n                if (result.data) {\n                    this.updateFormFields(form, result.data);\n                }\n                if (this.config.recordId === 'new' && result.id) {\n                    // Redirect to edit mode for the new ID to reload properly\n                    const newUrl = new URL(window.location.href);\n                    newUrl.searchParams.set('id', result.id);\n                    window.location.href = newUrl.toString();\n                }\n            }\n            // Restore button\n            btnSave.disabled = false;\n            btnSave.innerHTML = originalBtnHtml;\n        }\n        catch (error) {\n            this.showMessage(`Error al guardar: ${error.message}`, 'danger');\n            btnSave.disabled = false;\n            btnSave.innerHTML = originalBtnHtml;\n        }\n    }\n    updateFormFields(form, data) {\n        Object.entries(data).forEach(([key, val]) => {\n            const input = form.querySelector(`[name=\"${key}\"]`);\n            if (input) {\n                if (input.type === 'checkbox') {\n                    const isChecked = Boolean(val) && String(val) !== '0';\n                    input.checked = isChecked;\n                }\n                else {\n                    input.value = val;\n                }\n            }\n        });\n    }\n}\n\n\n//# sourceURL=webpack://AlxarafeResource/./src/Frontend/ts/resource.ts?\n}");

/***/ }

/******/ 	});
/************************************************************************/
/******/ 	// The require scope
/******/ 	var __webpack_require__ = {};
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__["./src/Frontend/ts/resource.ts"](0,__webpack_exports__,__webpack_require__);
/******/ 	
/******/ 	return __webpack_exports__;
/******/ })()
;
});
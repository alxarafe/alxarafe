!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AlxarafeResource=t():e.AlxarafeResource=t()}(self,()=>(()=>{"use strict";var e={d:(t,n)=>{for(var a in n)e.o(n,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:n[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{AlxarafeResource:()=>n});class n{constructor(e,t){this.activeTab="",this.currentOffset=0,this.activeFilters={},this.searchDebounceTimer=null,this.container=e,this.config=t,this.init()}init(){var e,t,n;if("list"===this.config.mode){this.activeTab=Object.keys((null===(e=this.config.config.list)||void 0===e?void 0:e.tabs)||{})[0]||"";const a=(null===(t=this.config.config.list)||void 0===t?void 0:t.tabs)||{};(null===(n=a[this.activeTab])||void 0===n?void 0:n.filters)&&a[this.activeTab].filters.forEach(e=>{e.value&&(this.activeFilters[e.field]=e.value)}),this.renderListLayout(),this.fetchData()}else this.renderEdit();this.injectStyles()}injectStyles(){const e="alxarafe-resource-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.innerHTML="\n            /* Scoped Select2 Fixes for Alxarafe Resource */\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 {\n                font-size: 0.875rem !important;\n            }\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection {\n                font-size: 0.875rem !important;\n                min-height: calc(1.5em + 0.5rem + 2px) !important;\n                padding: 0.25rem 0.5rem !important;\n            }\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection__rendered {\n                font-size: 0.875rem !important;\n                line-height: 1.5 !important;\n                color: #212529 !important;\n            }\n            .alxarafe-select2-wrapper .select2-container--bootstrap-5 .select2-selection__placeholder {\n                font-size: 0.875rem !important;\n                line-height: 1.5 !important;\n            }\n            /* Fix Dropdown too */\n            .select2-container--bootstrap-5 .select2-dropdown .select2-results__option {\n                font-size: 0.875rem !important;\n                padding: 0.25rem 0.75rem !important;\n            }\n        ",document.head.appendChild(t)}renderListLayout(){var e,t;const n=((null===(e=this.config.config.list)||void 0===e?void 0:e.tabs)||{})[this.activeTab];if(!n)return void(this.container.innerHTML='<div class="alert alert-danger">Configuration Error: Active tab not found.</div>');const a=(null===(t=this.config.config.list)||void 0===t?void 0:t.head_buttons)||[],i=a.filter(e=>"left"===e.location),r=a.filter(e=>!e.location||"right"===e.location),s=e=>`\n            <button class="btn btn-sm btn-${e.type}" \n                    ${"js"===e.action?`onclick="${e.target}"`:`onclick="window.location.href='${e.target}'"`}>\n                <i class="${e.icon} me-1"></i> ${e.label}\n            </button>\n        `;if(!this.config.templates||!this.config.templates.layout_list)return void(this.container.innerHTML='<div class="alert alert-danger">Internal Error: Missing template "layout_list"</div>');this.container.innerHTML=this.config.templates.layout_list;const o=this.container.querySelector("#alxarafe-tabs-container");o&&(o.innerHTML=this.renderTabsNav());const l=this.container.querySelector("#alxarafe-toolbar-left");l&&(l.innerHTML=i.map(s).join(""));const c=this.container.querySelector("#alxarafe-toolbar-right");c&&(c.innerHTML=r.map(s).join(""));const d=this.container.querySelector("#alxarafe-table-head");d&&(d.innerHTML=n.columns.map(e=>`\n                    <th class="py-3 px-4 border-0">${e.label}</th>\n                `).join("")+'<th class="text-end py-3 px-4 border-0" style="width: 120px;">Acciones</th>'),this.renderFilters(n.filters||[]);const h=this.container.querySelector("#alxarafe-filters-collapse");h&&(h.addEventListener("hide.bs.collapse",()=>{var e;null===(e=this.container.querySelector(".card-header .fa-chevron-up"))||void 0===e||e.classList.replace("fa-chevron-up","fa-chevron-down")}),h.addEventListener("show.bs.collapse",()=>{var e;null===(e=this.container.querySelector(".card-header .fa-chevron-down"))||void 0===e||e.classList.replace("fa-chevron-down","fa-chevron-up")})),this.setupAlertHelper()}setupAlertHelper(){if(!document.getElementById("alxarafe-alerts")){const e=document.createElement("div");e.id="alxarafe-alerts",this.container.prepend(e)}}showMessage(e,t="info"){const n=document.getElementById("alxarafe-alerts");if(!n)return;const a=`\n            <div class="alert alert-${t} alert-dismissible fade show" role="alert">\n                ${e}\n                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n            </div>\n        `;n.insertAdjacentHTML("beforeend",a)}renderTabsNav(){var e;const t=(null===(e=this.config.config.list)||void 0===e?void 0:e.tabs)||{},n=Object.keys(t);return n.length<=1?"":`\n            <ul class="nav nav-tabs mb-4">\n                ${n.map(e=>`\n                    <li class="nav-item">\n                        <a class="nav-link ${this.activeTab===e?"active":""}" \n                           href="#" \n                           data-tab="${e}"\n                           onclick="event.preventDefault();">\n                           ${t[e].title||t[e].label||e}\n                        </a>\n                    </li>\n                `).join("")}\n            </ul>\n        `}handleTabClick(e){const t=e.target.closest(".nav-link");if(!t)return;const n=t.dataset.tab;n&&n!==this.activeTab&&(this.activeTab=n,this.currentOffset=0,this.activeFilters={},this.renderListLayout(),this.fetchData())}renderFilters(e){var t;const n=this.container.querySelector("#alxarafe-filters-row");if(this.container.querySelectorAll(".nav-tabs .nav-link").forEach(e=>{e.addEventListener("click",e=>this.handleTabClick(e))}),n)if(0!==e.length){if(n.innerHTML=e.map(e=>{const t=this.activeFilters[e.field]||"",n=t?`\n                <button class="btn btn-outline-secondary alxarafe-filter-clear" type="button" data-field="${e.field}">\n                    <i class="fas fa-times"></i>\n                </button>\n            `:"";if("text"===e.type)return`\n                    <div class="col-md-3">\n                        <div class="input-group input-group-sm">\n                            <input type="text"\n                                class="form-control alxarafe-filter-input"\n                                data-field="${e.field}"\n                                placeholder="${e.label}..."\n                                value="${t}">\n                            ${n}\n                        </div>\n                    </div>\n                `;if("select"===e.type||"select2"===e.type){const a="select2"===e.type,i=Object.entries(e.options||{}).map(([e,n])=>`<option value="${e}" ${String(e)===String(t)?"selected":""}>${n}</option>`).join("");return a?`\n                    <div class="col-md-3 alxarafe-select2-wrapper">\n                        <select class="form-select form-select-sm alxarafe-filter-input select2" data-field="${e.field}" style="width: 100%" data-placeholder="-- ${e.label} --">\n                            <option value="">-- ${e.label} --</option>\n                            ${i}\n                        </select>\n                    </div>`:`\n                    <div class="col-md-3">\n                         <div class="input-group input-group-sm">\n                            <select class="form-select alxarafe-filter-input" data-field="${e.field}">\n                                <option value="">-- ${e.label} --</option>\n                                ${i}\n                            </select>\n                            ${t?n:""}\n                        </div>\n                    </div>\n                `}return""}).join(""),n.querySelectorAll(".alxarafe-filter-clear").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.field;this.clearFilter(t)})}),"function"==typeof window.refrescar_select2){window.refrescar_select2();const e=window.jQuery;e&&e(n).find(".select2").on("change",t=>{const n=t.target.getAttribute("data-field"),a=e(t.target).val();this.activeFilters[n]=a,this.currentOffset=0,this.fetchData()})}n.querySelectorAll(".alxarafe-filter-input:not(.select2)").forEach(e=>{"SELECT"===e.tagName?e.addEventListener("change",e=>this.handleFilterChange(e)):e.addEventListener("input",e=>this.handleFilterChange(e))})}else null===(t=this.container.querySelector("#alxarafe-filters-container"))||void 0===t||t.remove()}handleFilterChange(e){const t=e.target,n=t.dataset.field;if(!n)return;const a=t.value;this.activeFilters[n]=a,this.currentOffset=0,"text"===t.type?(clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=setTimeout(()=>this.fetchData(),300)):this.fetchData(),this.renderFilters(this.getFiltersConfig())}clearFilter(e){e&&(delete this.activeFilters[e],this.currentOffset=0,this.fetchData(),this.renderFilters(this.getFiltersConfig()))}getFiltersConfig(){var e;const t=((null===(e=this.config.config.list)||void 0===e?void 0:e.tabs)||{})[this.activeTab];return t&&t.filters||[]}async fetchData(){this.setTableLoading(!0);const e=new URL(window.location.href);e.searchParams.set("ajax","get_data"),e.searchParams.set("tab",this.activeTab),e.searchParams.set("offset",String(this.currentOffset)),Object.entries(this.activeFilters).forEach(([t,n])=>{n&&e.searchParams.set(`filter_${this.activeTab}_${t}`,n)});try{const t=await fetch(e.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error("Network error");const n=await t.json();this.populateTable(n.data),this.renderPagination(n.meta)}catch(e){this.showTableError(String(e))}}populateTable(e){var t,n;const a=this.container.querySelector("#alxarafe-table-body");if(!a)return;if(!e||0===e.length)return void(a.innerHTML='<tr><td colspan="100" class="text-center p-4 text-muted">No se encontraron resultados.</td></tr>');const i=null===(n=null===(t=this.config.config.list)||void 0===t?void 0:t.tabs)||void 0===n?void 0:n[this.activeTab];a.innerHTML=e.map(e=>{var t,n;return`\n            <tr onclick="window.location.href='?${this.getRoutingParams()}&id=${null!==(t=e.id)&&void 0!==t?t:e.code}'" style="cursor: pointer; transition: background-color 0.2s;">\n                ${i.columns.map(t=>`\n                    <td class="px-4 py-3 text-secondary">${this.formatValue(e[t.field],t)}</td>\n                `).join("")}\n                <td class="text-end px-4 py-3">\n                    <a href="?${this.getRoutingParams()}&id=${null!==(n=e.id)&&void 0!==n?n:e.code}" class="btn btn-sm btn-outline-primary rounded-pill px-3" title="Editar">\n                        <i class="fas fa-pen small"></i>\n                    </a>\n                </td>\n            </tr>\n        `}).join(""),this.formatLocalData()}formatLocalData(){this.container.querySelectorAll(".alx-date-local").forEach(e=>{const t=e.dataset.value;if(t)try{const n=new Date(t);isNaN(n.getTime())||(e.innerText=n.toLocaleDateString())}catch(e){}}),this.container.querySelectorAll(".alx-datetime-local").forEach(e=>{const t=e.dataset.value;if(t)try{const n=new Date(t);isNaN(n.getTime())||(e.innerText=n.toLocaleString())}catch(e){}}),this.container.querySelectorAll(".alx-decimal-local").forEach(e=>{const t=parseFloat(e.dataset.value);if(!isNaN(t))try{e.innerText=t.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:4})}catch(e){}}),this.container.querySelectorAll(".alx-time-local").forEach(e=>{const t=e.dataset.value;t&&t.includes(":")&&8===t.length&&(e.innerText=t.substring(0,5))})}renderPagination(e){const t=this.container.querySelector("#alxarafe-pagination");if(!t)return;const{total:n,limit:a,offset:i}=e,r=Math.floor(i/a)+1,s=Math.ceil(n/a),o=i+1,l=Math.min(i+a,n);if(0===n)return void(t.innerHTML="");const c=(e,t,n=!1,a=!1)=>`\n            <li class="page-item ${n?"disabled":""} ${a?"active":""}">\n                <button class="page-link" ${"number"==typeof e?`data-page="${e}"`:""} ${"number"!=typeof e?"disabled":""}>${t}</button>\n            </li>\n        `;let d=[];if(s<=7)for(let e=1;e<=s;e++)d.push(e);else{d.push(1),r>3&&d.push("...");for(let e=Math.max(2,r-1);e<=Math.min(s-1,r+1);e++)d.push(e);r<s-2&&d.push("..."),d.push(s)}const h=`\n            ${c(r-1,'<i class="fas fa-chevron-left"></i>',1===r)}\n            ${d.map(e=>"..."===e?'<li class="page-item disabled"><span class="page-link">...</span></li>':c(e,String(e),!1,e===r)).join("")}\n            ${c(r+1,'<i class="fas fa-chevron-right"></i>',r===s)}\n        `;if(this.config.templates&&this.config.templates.layout_pagination){let e=this.config.templates.layout_pagination;e=e.split("{{start}}").join(String(o)),e=e.split("{{end}}").join(String(l)),e=e.split("{{total}}").join(String(n)),e=e.split("{{items}}").join(h),t.innerHTML=e}else t.innerHTML='<div class="alert alert-warning">Missing template: layout_pagination</div>';t.querySelectorAll("button[data-page]:not([disabled])").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest("button");if(!t||!t.dataset.page)return;const n=parseInt(t.dataset.page);this.currentOffset=(n-1)*a,this.fetchData()})})}setTableLoading(e){var t,n,a,i;const r=this.container.querySelector("#alxarafe-table-body");if(r&&e){const e=((null===(i=null===(a=null===(n=null===(t=this.config.config.list)||void 0===t?void 0:t.tabs)||void 0===n?void 0:n[this.activeTab])||void 0===a?void 0:a.columns)||void 0===i?void 0:i.length)||0)+1;r.innerHTML=`<tr><td colspan="${e}" class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><br>Cargando...</td></tr>`}}showTableError(e){const t=this.container.querySelector("#alxarafe-table-body");t&&(t.innerHTML=`<tr><td colspan="100" class="text-center text-danger p-4">Error: ${e}</td></tr>`)}formatValue(e,t){var n;"string"==typeof t&&(t={type:t});const a=t.component||t.type||"text",i=null===(n=this.config.templates)||void 0===n?void 0:n[a.toLowerCase()+"_list"];if(i){let t=i;const n=null!=e?e:"";if(t=t.split("{{value}}").join(n),"boolean"===a){const n=Boolean(e)&&"0"!==String(e);t=t.split("{{checked}}").join(n?"checked":"")}return t}if(null==e)return"";if("icon"===t.type||"icon"===t.component){const n=t.map||{},a=void 0!==n[String(e)]?n[String(e)]:"";return a?`<i class="${a}"></i>`:""}return"boolean"===t.type?`<div class="text-center"><input type="checkbox" class="form-check-input" ${Boolean(e)&&"0"!==String(e)?"checked":""} disabled></div>`:String(e)}getRoutingParams(){const e=new URL(window.location.href),t=new URLSearchParams;return e.searchParams.has("page")&&t.set("page",e.searchParams.get("page")),e.searchParams.has("module")&&t.set("module",e.searchParams.get("module")),e.searchParams.has("controller")&&t.set("controller",e.searchParams.get("controller")),t.toString()}renderEdit(){var e;this.config.templates&&this.config.templates.layout_edit?(this.container.innerHTML=this.config.templates.layout_edit,this.loadRecordData(),this.setupAlertHelper(),null===(e=this.container.querySelector("#btn-save"))||void 0===e||e.addEventListener("click",()=>this.handleSave())):this.container.innerHTML='<div class="alert alert-danger">Internal Error: Missing template "layout_edit"</div>'}async loadRecordData(){const e=new URL(window.location.href);e.searchParams.set("ajax","get_record");try{const t=await fetch(e.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}}),n=await t.json();if(n.error)throw new Error(n.error);this.buildForm(n.data)}catch(e){const t=this.container.querySelector("#edit-form-container");t&&(t.innerHTML=`<div class="alert alert-danger">Error: ${e}</div>`)}}buildForm(e){var t;const n=this.container.querySelector("#edit-form-container");if(!n)return;const a=(null===(t=this.config.config.edit)||void 0===t?void 0:t.sections)||{},i=Object.entries(a);if(0===i.length)return void(n.innerHTML='<div class="alert alert-warning">No sections defined</div>');let r='<ul class="nav nav-tabs mb-3" role="tablist">';i.forEach(([e,t],n)=>{r+=`\n                <li class="nav-item" role="presentation">\n                    <button class="nav-link ${0===n?"active":""}" id="${e}-tab" data-bs-toggle="tab" data-bs-target="#tab-${e}" type="button" role="tab">\n                        ${t.title}\n                    </button>\n                </li>\n            `}),r+="</ul>";let s='<form id="alxarafe-edit-form"><div class="tab-content">';i.forEach(([t,n],a)=>{s+=`\n                <div class="tab-pane fade ${0===a?"show active":""}" id="tab-${t}" role="tabpanel">\n                    <div class="container-fluid p-0">\n                        <div class="row">\n            `,n.fields&&Object.values(n.fields).forEach(t=>{const n=void 0!==e[t.field]?e[t.field]:"";s+=this.renderField(t,n)}),s+="\n                        </div>\n                    </div>\n                </div>\n            "}),s+="</div></form>",n.innerHTML=r+s}renderField(e,t){var n;const a=e.type||e.component||"text",i=null===(n=this.config.templates)||void 0===n?void 0:n[a.toLowerCase()+"_edit"];if(i){let n=i;if(n=n.split("{{field}}").join(e.field),n=n.split("{{label}}").join(e.label),n=n.split("{{value}}").join(null!=t?t:""),["required","readonly","disabled"].forEach(t=>{var a;const i=!0===e[t]||!0===(null===(a=e.options)||void 0===a?void 0:a[t]);n=n.split(`{{${t}}}`).join(i?t:"")}),["min","max","step","maxlength","placeholder"].forEach(t=>{var a,i;const r=null!==(a=e[t])&&void 0!==a?a:null===(i=e.options)||void 0===i?void 0:i[t];n=null!=r?n.split(`{{${t}}}`).join(`${t}="${r}"`):n.split(`{{${t}}}`).join("")}),"boolean"===a){const e=Boolean(t)&&"0"!==String(t);n=n.split("{{checked}}").join(e?"checked":"")}return n}return`\n            <div class="col-md-6">\n                <label class="form-label small fw-bold text-secondary">${e.label}</label>\n                <input type="text" class="form-control" name="${e.field}" value="${t}">\n            </div>\n        `}async handleSave(){const e=this.container.querySelector("#alxarafe-edit-form");if(!e)return;const t=this.container.querySelector("#btn-save"),n=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';const a=new FormData(e),i={};a.forEach((e,t)=>{i[t]=e}),e.querySelectorAll('input[type="checkbox"]').forEach(e=>{i[e.name]=e.checked});const r=new URL(window.location.href);r.searchParams.set("ajax","save_record"),this.config.recordId&&r.searchParams.set("id",String(this.config.recordId));try{const a={data:{}};for(const[e,t]of Object.entries(i))a.data[e]=t;const s=await fetch(r.toString(),{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)}),o=await s.json();if("error"===o.status||o.error){let e=o.error||"Unknown error";throw o.errors&&Array.isArray(o.errors)&&(e=o.errors.join("<br>")),new Error(e)}if(this.showMessage("Guardado correctamente","success"),o.data&&this.updateFormFields(e,o.data),"new"===this.config.recordId&&o.id){const e=new URL(window.location.href);e.searchParams.set("id",o.id),window.location.href=e.toString()}t.disabled=!1,t.innerHTML=n}catch(e){this.showMessage(`Error al guardar: ${e.message}`,"danger"),t.disabled=!1,t.innerHTML=n}}updateFormFields(e,t){Object.entries(t).forEach(([t,n])=>{const a=e.querySelector(`[name="${t}"]`);if(a)if("checkbox"===a.type){const e=Boolean(n)&&"0"!==String(n);a.checked=e}else a.value=n})}}return t})());
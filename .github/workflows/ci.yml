name: CI

on:
  push:
  pull_request:

jobs:
  quality:
    runs-on: ubuntu-latest

    container:
      image: rsanjose/php851:latest
      options: --user root

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PHP Version
        run: php -v

      - name: Install Composer deps
        run: composer install --no-interaction --no-progress

      # ---------------------------
      # PHPCS + PHPCBF (estilo)
      # ---------------------------
      - name: PHPCBF (autofix)
        run: vendor/bin/phpcbf --tab-width=4 --encoding=utf-8 --standard=phpcs.xml src/Core -s

      - name: PHPCS (lint)
        run: vendor/bin/phpcs --tab-width=4 --encoding=utf-8 --standard=phpcs.xml src/Core -s

      # ---------------------------
      # PHPStan (an치lisis est치tico)
      # ---------------------------
      - name: PHPStan
        run: vendor/bin/phpstan analyse --memory-limit=1G

      # ---------------------------
      # Psalm (an치lisis profundo)
      # ---------------------------
      - name: Psalm
        run: vendor/bin/psalm --output-format=github

      # ---------------------------
      # PHPMD (complejidad, duplicaci칩n)
      # ---------------------------
      - name: PHPMD
        run: vendor/bin/phpmd src/Core text cleancode,codesize,controversial,design,naming,unusedcode

      # ---------------------------
      # PHP Metrics (score de calidad)
      # ---------------------------
      - name: PHP Metrics
        run: |
          mkdir -p reports
          vendor/bin/phpmetrics --report-html=reports/metrics src/Core

      - name: Upload PHP Metrics report
        uses: actions/upload-artifact@v4
        with:
          name: phpmetrics-report
          path: reports/metrics
